<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¹´ì¹´ì˜¤ ì§€ë„ ê²€ìƒ‰</title>
  <!-- âœ… ì¹´ì¹´ì˜¤ ì§€ë„ JS SDK (WebView2ì—ì„œ ë¡œë“œ ê°€ëŠ¥) -->
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=be680803e7b04c426b6e4b1666b17e67&libraries=services,places"></script>
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: sans-serif; }
    #searchContainer { display: flex; align-items: center; width: 100%; padding: 5px; box-sizing: border-box; border-bottom: 1px solid #ccc; }
    #searchBox { flex: 1; height: 40px; font-size: 14px; border: none; outline: none; padding: 0 8px; }
    #searchButton { height: 40px; margin-left: 8px; padding: 0 16px; font-size: 14px; cursor: pointer; }
    #map { width: 500px; height: 400px; margin: 10px auto; }
    #resultList { width: 100%; height: calc(30vh - 40px); overflow-y: auto; margin: 10px auto; max-width: 500px; }
    .resultItem { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
    .resultItem:hover { background: #f2f2f2; }
  </style>
</head>
<body>
  <!-- âœ… ê²€ìƒ‰ì°½ -->
  <div id="searchContainer">
    <input type="text" id="searchBox" placeholder="ì£¼ì†Œë‚˜ ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”" onkeydown="if(event.key === 'Enter'){searchPlaces();}">
    <button id="searchButton" onclick="searchPlaces();">ê²€ìƒ‰</button>
  </div>
  
  <!-- âœ… ì§€ë„ í‘œì‹œ -->
  <div id="map"></div>

  <!-- âœ… ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ -->
  <div id="resultList"></div>

  <script>
    let map;             // ì§€ë„ ê°ì²´
    let ps;              // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ (Places)
    let markers = [];    // ë§ˆì»¤ ë¦¬ìŠ¤íŠ¸

    // âœ… ì§€ë„ ì´ˆê¸°í™”
    function initMap() {
      const mapContainer = document.getElementById('map');
      const mapOption = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 3 };
      map = new kakao.maps.Map(mapContainer, mapOption);
      ps = new kakao.maps.services.Places(); // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ ìƒì„±
      console.log("âœ… ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ");
    }

    // âœ… ê²€ìƒ‰ ì‹¤í–‰ í•¨ìˆ˜
    function searchPlaces() {
      const query = document.getElementById('searchBox').value.trim();
      if (!query) {
        alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      console.log("ğŸ” ê²€ìƒ‰ì–´:", query);
      ps.keywordSearch(query, placesSearchCB);
    }

    // âœ… ì¥ì†Œ ê²€ìƒ‰ ì½œë°± í•¨ìˆ˜
    function placesSearchCB(data, status, pagination) {
      if (status === kakao.maps.services.Status.OK) {
        console.log("âœ… ê²€ìƒ‰ ê²°ê³¼:", data);
        displayPlaces(data);
      } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
        alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
      } else {
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // âœ… ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
    function displayPlaces(places) {
      const resultList = document.getElementById('resultList');
      resultList.innerHTML = '';
      clearMarkers();

      for (let i = 0; i < places.length; i++) {
        const place = places[i];
        const itemEl = document.createElement('div');
        itemEl.className = 'resultItem';

        // ë°ì´í„° ì†ì„± ì €ì¥
        itemEl.dataset.placeName = place.place_name;
        itemEl.dataset.addressName = place.address_name;
        itemEl.dataset.roadAddressName = place.road_address_name;
        itemEl.dataset.x = place.x;
        itemEl.dataset.y = place.y;

        // í™”ë©´ í‘œì‹œ ë‚´ìš©
        const address = place.road_address_name || place.address_name;
        itemEl.innerHTML = `<b>${place.place_name}</b><br/>${address}`;

        // âœ… í´ë¦­ ì´ë²¤íŠ¸: ì„ íƒ ì‹œ ì§€ë„ ì´ë™ ë° Flutter ë©”ì‹œì§€ ì „ì†¡
        itemEl.onclick = function() {
          const name = this.dataset.placeName;
          const addr = this.dataset.roadAddressName || this.dataset.addressName;
          const x = this.dataset.x;
          const y = this.dataset.y;

          // ì§€ë„ ì´ë™ + ë§ˆì»¤ í‘œì‹œ
          const latlng = new kakao.maps.LatLng(y, x);
          map.setCenter(latlng);
          console.log("ğŸ“ ì§€ë„ ì¤‘ì‹¬ ì´ë™:", latlng);

          const marker = new kakao.maps.Marker({ position: latlng });
          marker.setMap(map);
          markers.push(marker);

          // âœ… ì£¼ì†Œ ê°ì²´ ìƒì„±
          const addressObj = { addressName: name, detailedAddress: addr };
          console.log("ğŸ“Œ ì„ íƒëœ ì£¼ì†Œ ê°ì²´:", addressObj);

            // âœ… WebView2 í™˜ê²½ ê³ ë ¤í•˜ì—¬ ë©”ì‹œì§€ ì „ì†¡ ë°©ì‹ ë³€ê²½
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage(JSON.stringify(addressObj));
            } else if (window.FlutterChannel) {
                window.FlutterChannel.postMessage(JSON.stringify(addressObj));
            } else {
                alert("âœ… ì„ íƒëœ ì£¼ì†Œ: " + JSON.stringify(addressObj));
            }
        };

        resultList.appendChild(itemEl);
      }
    }

    // âœ… ë§ˆì»¤ ì´ˆê¸°í™” í•¨ìˆ˜
    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }

    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
    window.onload = function() {
      initMap();
    };
  </script>
</body>
</html>
