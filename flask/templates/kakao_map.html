<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¹´ì¹´ì˜¤ ì§€ë„ ê²€ìƒ‰</title>
  <!-- ì¹´ì¹´ì˜¤ ì§€ë„ JS SDK (WebView2ì—ì„œ ë¡œë“œ ê°€ëŠ¥) -->
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=be680803e7b04c426b6e4b1666b17e67&libraries=services,places"></script>
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: sans-serif; }
    /* ê²€ìƒ‰ì°½ ì˜ì—­ */
    #searchContainer { display: flex; align-items: center; width: 100%; padding: 5px; box-sizing: border-box; border-bottom: 1px solid #ccc; }
    #searchBox { flex: 1; height: 40px; font-size: 14px; border: none; outline: none; padding: 0 8px; }
    #searchButton { height: 40px; margin-left: 8px; padding: 0 16px; font-size: 14px; cursor: pointer; }
    /* ì§€ë„ ì˜ì—­ */
    #map { width: 100%; height: 400px; margin: 10px auto; position: relative; }
    /* ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ */
    #resultList { width: 100%; height: calc(30vh - 40px); overflow-y: auto; margin: 10px auto; max-width: 500px; }
    .resultItem { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
    .resultItem:hover { background: #f2f2f2; }
    /* Zoom Buttons */
    #zoomButtons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      background: rgba(255,255,255,0.8);
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow: hidden;
      z-index: 999;
    }
    #zoomButtons button { padding: 8px; border: none; background: none; cursor: pointer; }
    /* Current Location Controls */
    #currentLocationControls {
      position: absolute;
      bottom: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 1000;
    }
    #currentLocationControls button {
      padding: 8px;
      font-size: 14px;
      border: none;
      background: rgba(255,255,255,0.8);
      cursor: pointer;
      border-radius: 4px;
    }
    /* Center Icon Overlay */
    #centerIcon {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 500;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <!-- ê²€ìƒ‰ì°½ -->
  <div id="searchContainer">
    <input type="text" id="searchBox" placeholder="ì£¼ì†Œë‚˜ ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”" onkeydown="if(event.key === 'Enter'){searchPlaces();}">
    <button id="searchButton" onclick="searchPlaces();">ê²€ìƒ‰</button>
  </div>
  
  <!-- ì§€ë„ í‘œì‹œ -->
  <div id="map"></div>
  <!-- ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ -->
  <div id="resultList"></div>

  <script>
    let map, ps, markers = [];
    let currentMarker = null;

    // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì¶”ì¶œ í•¨ìˆ˜
    function getQueryParam(param) {
      var params = new URLSearchParams(window.location.search);
      return params.get(param);
    }

    function initMap() {
      const mapContainer = document.getElementById('map');
      // ê¸°ë³¸ ì¤‘ì‹¬ ì¢Œí‘œ: ì°½ì›ëŒ€í•™êµ
      const mapOption = { center: new kakao.maps.LatLng(35.2456868, 128.69189572), level: 3 };
      map = new kakao.maps.Map(mapContainer, mapOption);
      ps = new kakao.maps.services.Places();
      console.log("âœ… ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ");

      // initialAddress íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ìƒì„¸ì£¼ì†Œë¡œ ê°„ì£¼í•˜ì—¬ geocode í›„ ì§€ë„ ì¤‘ì‹¬ ì´ë™
      var initialAddress = getQueryParam('initialAddress');
      if (initialAddress) {
        var geocoder = new kakao.maps.services.Geocoder();
        geocoder.addressSearch(initialAddress, function(result, status) {
          if (status === kakao.maps.services.Status.OK) {
            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
            map.setCenter(coords);
            var marker = new kakao.maps.Marker({ map: map, position: coords });
            console.log("Initial address loaded: " + initialAddress);
          } else {
            console.error("Address search failed for: " + initialAddress);
          }
        });
      }

      createZoomButtons();
      createCurrentLocationControls();
    }

    function searchPlaces() {
      const query = document.getElementById('searchBox').value.trim();
      if (!query) { alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      console.log("ğŸ” ê²€ìƒ‰ì–´:", query);
      ps.keywordSearch(query, placesSearchCB);
    }

    function placesSearchCB(data, status, pagination) {
      if (status === kakao.maps.services.Status.OK) {
        console.log("âœ… ê²€ìƒ‰ ê²°ê³¼:", data);
        displayPlaces(data);
      } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
        alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
      } else {
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function displayPlaces(places) {
      const resultList = document.getElementById('resultList');
      resultList.innerHTML = '';
      clearMarkers();
      for (let i = 0; i < places.length; i++) {
        const place = places[i];
        const itemEl = document.createElement('div');
        itemEl.className = 'resultItem';
        itemEl.dataset.placeName = place.place_name;
        itemEl.dataset.addressName = place.address_name;
        itemEl.dataset.roadAddressName = place.road_address_name;
        itemEl.dataset.x = place.x;
        itemEl.dataset.y = place.y;
        const address = place.road_address_name || place.address_name;
        itemEl.innerHTML = `<b>${place.place_name}</b><br/>${address}`;
        itemEl.onclick = function() {
          const name = this.dataset.placeName;
          const addr = this.dataset.roadAddressName || this.dataset.addressName;
          const x = this.dataset.x;
          const y = this.dataset.y;
          const latlng = new kakao.maps.LatLng(y, x);
          map.setCenter(latlng);
          console.log("ğŸ“ ì§€ë„ ì¤‘ì‹¬ ì´ë™:", latlng);
          var marker = new kakao.maps.Marker({ position: latlng });
          marker.setMap(map);
          markers.push(marker);
          const addressObj = { addressName: name, detailedAddress: addr };
          console.log("ğŸ“Œ ì„ íƒëœ ì£¼ì†Œ ê°ì²´:", addressObj);
          if (window.chrome && window.chrome.webview) {
              window.chrome.webview.postMessage(JSON.stringify(addressObj));
          } else if (window.FlutterChannel) {
              window.FlutterChannel.postMessage(JSON.stringify(addressObj));
          } else {
              alert("âœ… ì„ íƒëœ ì£¼ì†Œ: " + JSON.stringify(addressObj));
          }
        };
        resultList.appendChild(itemEl);
      }
    }

    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }

    // Zoom buttons (top-right)
    function createZoomButtons() {
      const mapContainer = document.getElementById('map');
      const buttonContainer = document.createElement('div');
      buttonContainer.id = 'zoomButtons';
      buttonContainer.style.top = '10px';
      buttonContainer.style.right = '10px';
      buttonContainer.style.display = 'flex';
      buttonContainer.style.flexDirection = 'column';
      buttonContainer.style.background = 'rgba(255,255,255,0.8)';
      buttonContainer.style.border = '1px solid #ccc';
      buttonContainer.style.borderRadius = '4px';
      buttonContainer.style.overflow = 'hidden';
      buttonContainer.style.zIndex = '999';

      const zoomInButton = document.createElement('button');
      zoomInButton.innerText = '+';
      zoomInButton.style.padding = '8px';
      zoomInButton.style.border = 'none';
      zoomInButton.style.background = 'none';
      zoomInButton.style.cursor = 'pointer';
      zoomInButton.addEventListener('click', function() {
        let currentLevel = map.getLevel();
        if (currentLevel > 1) {
          map.setLevel(currentLevel - 1);
        }
      });

      const zoomOutButton = document.createElement('button');
      zoomOutButton.innerText = '-';
      zoomOutButton.style.padding = '8px';
      zoomOutButton.style.border = 'none';
      zoomOutButton.style.background = 'none';
      zoomOutButton.style.cursor = 'pointer';
      zoomOutButton.addEventListener('click', function() {
        let currentLevel = map.getLevel();
        map.setLevel(currentLevel + 1);
      });

      buttonContainer.appendChild(zoomInButton);
      buttonContainer.appendChild(zoomOutButton);
      mapContainer.appendChild(buttonContainer);
    }

    // Current location controls (bottom-right)
    function createCurrentLocationControls() {
      const mapContainer = document.getElementById('map');
      const controlContainer = document.createElement('div');
      controlContainer.id = 'currentLocationControls';

      // "í˜„ì¬ ìœ„ì¹˜" ë²„íŠ¼: ì§€ë„ ì¤‘ì•™ì— ê³ ì •ëœ ì˜¤ë²„ë ˆì´ ì•„ì´ì½˜ ìƒì„±
      const currentLocButton = document.createElement('button');
      currentLocButton.innerText = 'í˜„ì¬ ìœ„ì¹˜';
      currentLocButton.addEventListener('click', function() {
        if (!document.getElementById('centerIcon')) {
          const centerIcon = document.createElement('img');
          centerIcon.id = 'centerIcon';
          centerIcon.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
          centerIcon.style.width = '24px';
          centerIcon.style.height = '35px';
          document.getElementById('map').appendChild(centerIcon);
        }
      });

      // "í™•ì¸" ë²„íŠ¼: ì§€ë„ ì¤‘ì•™ ì¢Œí‘œë¥¼ reverse geocodingí•˜ì—¬ ì£¼ì†Œ ë°˜í™˜
      const confirmButton = document.createElement('button');
      confirmButton.innerText = 'í™•ì¸';
      confirmButton.addEventListener('click', function() {
        const center = map.getCenter();
        const geocoder = new kakao.maps.services.Geocoder();
        geocoder.coord2Address(center.getLng(), center.getLat(), function(result, status) {
          if (status === kakao.maps.services.Status.OK) {
            const address = result[0].address.address_name;
            const addressObj = {
              addressName: "í¬ì¸íŠ¸ ìœ„ì¹˜",
              detailedAddress: address
            };
            console.log("ğŸ“Œ í˜„ì¬ ìœ„ì¹˜ ì„ íƒ:", addressObj);
            if (window.chrome && window.chrome.webview) {
              window.chrome.webview.postMessage(JSON.stringify(addressObj));
            } else if (window.FlutterChannel) {
              window.FlutterChannel.postMessage(JSON.stringify(addressObj));
            } else {
              alert("âœ… ì„ íƒëœ ì£¼ì†Œ: " + JSON.stringify(addressObj));
            }
            const centerIcon = document.getElementById('centerIcon');
            if (centerIcon) { centerIcon.remove(); }
          } else {
            alert("ì£¼ì†Œ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        });
      });

      controlContainer.appendChild(currentLocButton);
      controlContainer.appendChild(confirmButton);
      mapContainer.appendChild(controlContainer);
    }

    window.onload = function() {
      initMap();
    };
  </script>
</body>
</html>
